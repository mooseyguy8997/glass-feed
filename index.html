<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
  <link rel="stylesheet" href="css/style.css">
  <meta name="description" content="">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">
  <meta property="og:image:alt" content="">

  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="icon.png">

  <link rel="manifest" href="site.webmanifest">
  <meta name="theme-color" content="#fafafa">

  <style>
    body {
      align-items: center;
      align-content: center;
      margin: 5px;
      font-family: "Roboto", sans-serif;
      background-color: #DEFFDA;
    }
    .topbar {
      align-items: center;
      text-align: center;
    }
    #title{
      height: 150px;
      width: 100%;
    }
    p {
      font-size: 20px;
      font-weight: 600;
      font-family: "Roboto Mono", sans-serif;
    }
    button {
      position: fixed;
      right: 5px;
      top: 5px;

      display: compact;

      font-family: "Roboto Mono", sans-serif;
      background-color: rgba(0, 0, 0, 0);
      border: none;
      filter: invert(0.5);

      margin: 0;
      padding: 0;
    }
    #audiosetting {
      top: 50px;
    }
    button a{
      visibility: hidden;
    }
    button:hover{
      filter: invert(0.6);
    }
    button:hover a{
      visibility: visible;
    }
    button:active {
      filter: invert(0.3);
    }
    button img {
      width: 50px;
      height: 50px;
    }

    .area:hover {
      background-color: #F5F5F5;
    }

    #feed {
      display: grid;
      grid-gap: 10px;
    }

    #data-monitor {
      position: fixed;
      right: 20px;
      top: 100px;
      width: 250px;
      background: white;
      border: 2px solid black;
      padding: 10px;
      font-family: "Roboto Mono", monospace;
      font-size: 12px;
      display: block; /* We will toggle this with your button */
    }

    #timer {
      position: fixed;
      top: 5px;
      left: 20px;
      visibility: visible;
      color: #C30000FF
    }

    .bottom-bar {
      text-align: center;
      margin: 10px;
    }

    #finish {
      font-family: "Roboto Mono", sans-serif;
      font-weight: 600;
      font-size: 24px;

      border-radius: 8px;
      border: none;
      background-color: #37c6aa;
    }

    #loadingscreen {
      top: 0;
      left: 0;

      position: fixed;
      width: 100vw;
      height: 100vh;
      text-align: center;
      justify-content: center;
      background-color: white;

      display: grid;
      place-items: center; /* Centers both horizontally and vertically */
    }

    #loading {
      height: 100px;
      filter: invert(0.5);
    }


    #popup {

      visibility: hidden;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: grid;
      position: fixed;
      place-items: center;
      background-color: rgba(0, 0, 0, 0.3);
    }
    #popup-title {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      background-color: #f0f0f0;
      border-radius: 8px;
    }
    #popup-content {
      text-align: left;
      font-weight: 400;
      font-size: 16px;

      display: inherit;
    }
    #popup-container {
      width: 40vw;
      background-color: white;
      border: none;
      border-radius: 8px;
      padding: 16px;
    }

    #popup-button {
      height: 32px;
      font-family: "Roboto Mono", sans-serif;
      font-weight: 600;
      background-color: #37c6ff;
      box-shadow: #999999 2px 2px 1px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      width: 100%;
    }
    #popup-button:hover {
      background-color: #63d3ff;
    }
    #popup-button:active {
      background-color: #2d82a5;
    }

  </style>
</head>

<body>


  <div class="topbar">
    <img id="title" src="img/TheGlassFeed.svg">
    <p>Toggle tracking visibility with the toggle eye to the right.</p>
    <button onclick="toggleVisibility()"><a id="info">Show data collection [ON]</a><img id="status" src="img/visibilityon.svg" alt="Visibility"></button>
    <button id="audiosetting" onclick="toggleAudio()"><a id="audioinfo">Toggle audio [OFF]</a><img id="audiostat" src="img/volumeoff.svg" alt="Visibility"></button>
    <p id="timer">00:00:00</p>
  </div>
  <div id="data-monitor">
    <strong>LIVE ALGORITHM LOG</strong>
    <hr>
    <div id="log-content">Awaiting engagement...</div>
  </div>



  <div id="feed">
  </div>

  <div class="bottom-bar">
    <p>Press the button below to analyze the results and see what it could be used for.</p>
    <input type="button" id="finish" onclick="finish()" value="FINISH">
  </div>

  <div id="loadingscreen">
    <div id="loadingscreenobjects">
      <img id="loading" src="img/gear.svg">
      <p>Loading...</p>
    </div>
  </div>

  <div id="popup">
    <div id="popup-container">
      <p id="popup-title"></p>
      <p id="popup-content"></p>
      <input type="button" value="Close" id="popup-button">
    </div>
  </div>

</body>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
  const categoryTimes = {};

  let popup = document.getElementById("popup");
  let popupContainer = document.getElementById("popup-container");
  let popupTitle = document.getElementById("popup-title");
  let popupContent = document.getElementById("popup-content");
  let popupButton = document.getElementById("popup-button");


  function openPopup(title, content, button, onPressFunction) {

    popupTitle.innerHTML = title;
    popupContent.innerHTML = content;
    popup.style.visibility = "visible";
    popupButton.value = button;

    popupButton.addEventListener("click", onPressFunction);
    popupButton.addEventListener("click", function () {popup.style.visibility = "hidden";});


  }




  let startTime;
  let elapsedTime = 0;
  let timerInterval;

  const display = document.getElementById('timer');

  // Function to format time (MM:SS:ms)
  function formatTime(time) {
    let hundredths = Math.floor((time % 1000) / 10); // Get hundredths of a second
    let seconds = Math.floor(time / 1000) % 60;
    let minutes = Math.floor(time / (1000 * 60)) % 60;

    // Use padStart to ensure two digits
    minutes = minutes.toString().padStart(2, "0");
    seconds = seconds.toString().padStart(2, "0");
    hundredths = hundredths.toString().padStart(2, "0");

    return `${minutes}:${seconds}:${hundredths}`;
  }

  // Start function
  function start() {
    startTime = Date.now() - elapsedTime;
    timerInterval = setInterval(function printTime() {
      elapsedTime = Date.now() - startTime;
      display.textContent = formatTime(elapsedTime);
      document.getElementById("loading").style.rotate = elapsedTime/4+"deg";
      if (elapsedTime > 1500) {
        document.getElementById("loadingscreen").style.visibility = "hidden";
      }
    }, 10); // Update every 10ms for hundredths
  }

  // 1. Global Variables
  let visibility = true;
  let audio = false; // Start with audio OFF
  let seen = [];
  let done = 0;

  openPopup("Ethics Project Artifact #1 (Bjorn S.)", "A website that has a feed of random content in different categories, at the end displaying collected information and possible uses of it, like in targeted ads.\n\nThis shows how you ways a company could harvest your use of their app, the company needing it to stay alive and you to be able to have access. This comes at risks, like data leaks or harmful overuse/addiction.\n\nUse the eye in the top right for tracking visibility.", "Start", function() {
    start();
  });

  // Storage for all active player instances to control volume later
  const pexelsPlayers = [];
  const ytPlayers = [];

  // 2. Toggling Logic
  function toggleVisibility() {
    visibility = !visibility;
    document.getElementById("status").src = visibility ? "img/visibilityon.svg" : "img/visibilityoff.svg";
    document.getElementById("data-monitor").style.visibility = visibility ? "visible" : "hidden";
    document.getElementById("timer").style.visibility = visibility ? "visible" : "hidden";
    document.getElementById("title").style.filter = visibility ? "invert(1)" : "none";

    document.body.style.backgroundColor = visibility ? "#f55f55" : "#DEFFDA";
    document.getElementById("info").innerHTML = `Show data collection [${visibility ? 'ON' : 'OFF'}]`;
  }
  toggleVisibility();

  function toggleAudio() {
    audio = !audio;

    // Update the UI
    document.getElementById("audiostat").src = audio ? "img/volumeon.svg" : "img/volumeoff.svg";
    document.getElementById("audioinfo").innerHTML = `Toggle audio [${audio ? 'ON' : 'OFF'}]`;

    // Update all Pexels videos
    pexelsPlayers.forEach(v => {
      v.muted = !audio;
    });

    // Update all YouTube videos
    ytPlayers.forEach(p => {
      if (p && p.mute) {
        audio ? p.unMute() : p.mute();
      }
    });

    console.log("Global Audio set to:", audio);
  }

  function getRandomInt(max) {
    return Math.floor(Math.random() * max);
  }

  // 3. The Data
  const postData = [
    {src: "u3N-2lIE11k", category: "tech", author: "Games_for_James", caption: "looks like a pretty awesome device"},
    {src: "jlUY9cYEoJQ", category: "gaming", author: "ThatMumboJumbo", caption: "mumbo sucks at games"},
    {src: "P-4pbFcERnk", category: "science", author: "veritasium", caption: "coke bottle"},
    {src: "5vUBGuRdMf0", category: "tech", author: "Gears2181", caption: "cool intake and hopper in frc robotics"}
  ];

  // 4. Build the Feed
  function buildFeed() {
    const feed = document.getElementById("feed");
    while (done < 10 && seen.length < postData.length) {
      let ranint = getRandomInt(postData.length);
      if (!seen.includes(ranint)) {
        seen.push(ranint);
        done++;
        createPost(postData[ranint], done);
      }
    }
  }





  function createPost(post, index) {
    const feed = document.getElementById("feed");
    let area = document.createElement("div");
    area.className = "area";
    area.style.padding = "20px";
    area.style.borderRadius = "8px";
    //area.style.borderBottom = "16px solid #DEFFDA";
    area.style.backgroundColor = "#ffffff";

    let authorlabel = document.createElement("p");
    authorlabel.innerHTML = `@${post.author}`;
    let categorylabel = document.createElement("p");
    categorylabel.innerHTML = post.category.toUpperCase();
    categorylabel.style.fontSize = "12px";
    categorylabel.style.color = "#666";
    let captionlabel = document.createElement("p");
    captionlabel.innerHTML = post.caption || "";
    captionlabel.style.fontSize = "12px";

    let videoEl = null;
    let ytPlayerObj = null;

    if (categoryTimes[post.category] === undefined) {
      categoryTimes[post.category] = 0;
    }

    if (post.src.includes("pexels.com")) {
      videoEl = document.createElement("video");
      videoEl.src = post.src;
      videoEl.muted = !audio; // Respect current audio state
      videoEl.loop = true;
      videoEl.style.width = "400px";
      videoEl.style.borderRadius = "8px";
      area.appendChild(videoEl);
      pexelsPlayers.push(videoEl); // Store for global control
    } else {
      let ytDiv = document.createElement("div");
      let uniqueID = `yt-player-${index}`;
      ytDiv.id = uniqueID;
      area.appendChild(ytDiv);

      setTimeout(() => {
        if (window.YT && YT.Player) {
          ytPlayerObj = new YT.Player(uniqueID, {
            height: '500',
            width: '889',
            videoId: post.src,
            playerVars: {
              'autoplay': 0,
              'controls': 1,
              'rel': 0,
              'mute': audio ? 0 : 1, // 1 is muted, 0 is unmuted,
              'cc_load_policy': 1
            },
            events: {
              'onReady': (event) => {
                ytPlayers.push(event.target); // Store for global control
              }
            }
          });
        }
      }, 1000);
    }

    area.appendChild(authorlabel);
    area.appendChild(categorylabel);
    area.appendChild(captionlabel);
    feed.appendChild(area);


    let startTime;
    area.onmouseenter = () => {
      startTime = performance.now();
      if (visibility) area.style.backgroundColor = "#ffdbdb";
      if (videoEl) videoEl.play();
      if (ytPlayerObj && ytPlayerObj.playVideo) ytPlayerObj.playVideo();
    };


    area.onmouseleave = () => {
      if (startTime === undefined) return;
      let duration = ((performance.now() - startTime) / 1000).toFixed(2);

      categoryTimes[post.category] += duration;
      area.style.backgroundColor = "#ffffff";
      if (videoEl) videoEl.pause();
      if (ytPlayerObj && ytPlayerObj.pauseVideo) ytPlayerObj.pauseVideo();

      if (duration > 0.1) {
        document.getElementById("log-content").innerHTML =
          `> Observed ${duration}s on ${post.category.toUpperCase()}<br>` +
          document.getElementById("log-content").innerHTML;
      }
    };
  }

  buildFeed();

  function finish() {
    // Stop the timer
    clearInterval(timerInterval);

    // Build the analysis content
    let analysisHTML = `<strong>Total Session Time:</strong> ${display.innerHTML}<br><br>`;
    analysisHTML += `<strong>Category Breakdown:</strong><br>`;
    analysisHTML += `<table style="width:100%; border-collapse: collapse; margin-top: 10px; font-family: 'Roboto Mono', monospace; font-size: 14px;">`;
    analysisHTML += `<tr style="border-bottom: 2px solid #37c6ff; font-weight: bold;"><td>Category</td><td>Total Time</td></tr>`;

    let mostWatched = { cat: "None", time: 0 };

    // Get all categories that have been tracked
    const categories = Object.keys(categoryTimes);

    categories.forEach(cat => {
      // Force conversion to float to prevent "0" errors from math jitter
      let rawValue = parseFloat(categoryTimes[cat]);

      // Handle cases where the category exists but has no time (NaN/Undefined)
      if (isNaN(rawValue)) rawValue = 0;

      // Determine if this is the highest engagement
      if (rawValue > mostWatched.time) {
        mostWatched = { cat: cat.toUpperCase(), time: rawValue };
      }

      analysisHTML += `<tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 5px 0;">${cat.toUpperCase()}</td>
                            <td>${rawValue.toFixed(2)}s</td>
                         </tr>`;
    });

    analysisHTML += `</table>`;

    if (mostWatched.time > 0.1) {
      analysisHTML += `<br><div style="background: #e1f5fe; padding: 10px; border-radius: 5px; font-size: 14px; border: 1px solid #b3e5fc;">
                            <strong>Algorithm Insight:</strong> High engagement detected in <b>${mostWatched.cat}</b>.
                            Your profile has been categorized for <b>${mostWatched.cat.toLowerCase()}</b> optimization.
                         </div>`;
    } else {
      analysisHTML += `<br><p style="font-size: 14px; color: #666;">Minimal engagement detected. Profile remains generic.</p>`;
    }

    openPopup("Data Analysis Complete", analysisHTML, "Restart Session", function() {
      window.location.reload();
    });
  }
</script>

</html>
